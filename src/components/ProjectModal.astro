---
import { projects } from "../data/projects";
---

<div id="project-modal" class="fixed inset-0 z-[100] pointer-events-none" aria-hidden="true">
  <div id="modal-backdrop" class="absolute inset-0 bg-black/0 transition-all duration-500"></div>
  
  <div class="absolute inset-0 flex items-center justify-center p-4 md:p-8">
    <div
      id="modal-content"
      class="relative w-full max-w-4xl max-h-[90vh] rounded-2xl overflow-hidden opacity-0 scale-90 translate-y-8 transition-all duration-500 ease-out"
      style="background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(24px); border: 1px solid rgba(148, 163, 184, 0.1);"
    >
      <button
        id="modal-close"
        class="absolute top-4 right-4 z-10 w-10 h-10 rounded-full bg-black/40 backdrop-blur-sm flex items-center justify-center text-white/70 hover:text-white hover:bg-black/60 transition-all duration-200 hover:rotate-90"
        aria-label="Close"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <div id="modal-scroll" class="overflow-y-auto max-h-[90vh] overscroll-contain">
        <div id="modal-banner" class="relative h-56 md:h-64 overflow-hidden">
          <div id="modal-gradient" class="absolute inset-0 opacity-90"></div>
          <img id="modal-image" src="" alt="" class="w-full h-full object-cover mix-blend-overlay opacity-40" onerror="this.style.display='none'" />
          <div class="absolute inset-0 flex flex-col justify-end p-8">
            <span id="modal-category" class="inline-block w-fit px-3 py-1 text-xs font-semibold uppercase tracking-wider bg-black/30 backdrop-blur-sm rounded-full text-white mb-3"></span>
            <h2 id="modal-title" class="text-3xl md:text-4xl font-extrabold text-white mb-1"></h2>
            <p id="modal-subtitle" class="text-white/80 text-lg"></p>
          </div>
        </div>

        <div class="p-8 md:p-10">
          <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
              <div id="modal-highlights-wrap">
                <span id="modal-highlights" class="text-xs font-mono text-primary-light bg-primary/10 px-4 py-1.5 rounded-full"></span>
              </div>

              <div>
                <h3 class="text-lg font-bold mb-4">About This Project</h3>
                <div id="modal-description" class="space-y-4"></div>
              </div>

              <div>
                <h3 class="text-lg font-bold mb-4">Key Features</h3>
                <ul id="modal-features" class="space-y-3"></ul>
              </div>
            </div>

            <div class="space-y-6">
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wider text-text-muted mb-4">Tech Stack</h3>
                <div id="modal-tech" class="flex flex-wrap gap-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ projectsData: projects }}>
  window.__PROJECTS__ = projectsData;
</script>

<script>
  const modal = document.getElementById("project-modal")!;
  const backdrop = document.getElementById("modal-backdrop")!;
  const content = document.getElementById("modal-content")!;
  const closeBtn = document.getElementById("modal-close")!;
  const scrollArea = document.getElementById("modal-scroll")!;

  const modalTitle = document.getElementById("modal-title")!;
  const modalSubtitle = document.getElementById("modal-subtitle")!;
  const modalCategory = document.getElementById("modal-category")!;
  const modalGradient = document.getElementById("modal-gradient")!;
  const modalImage = document.getElementById("modal-image") as HTMLImageElement;
  const modalHighlights = document.getElementById("modal-highlights")!;
  const modalDescription = document.getElementById("modal-description")!;
  const modalFeatures = document.getElementById("modal-features")!;
  const modalTech = document.getElementById("modal-tech")!;

  function openModal(projectId: string) {
    const projects = (window as any).__PROJECTS__ as any[];
    const project = projects.find((p) => p.id === projectId);
    if (!project) return;

    modalTitle.textContent = project.title;
    modalSubtitle.textContent = project.subtitle;
    modalCategory.textContent = project.category;
    modalGradient.className = `absolute inset-0 bg-gradient-to-br ${project.color} opacity-90`;
    modalImage.src = project.image;
    modalImage.alt = project.title;
    modalImage.style.display = "";
    modalHighlights.textContent = project.highlights;

    modalDescription.innerHTML = project.longDescription
      .split("\n\n")
      .map((p: string, i: number) => `<p class="text-text-muted leading-relaxed modal-para" style="opacity:0; transform:translateY(12px); transition: all 0.4s ease ${0.15 + i * 0.08}s">${p}</p>`)
      .join("");

    modalFeatures.innerHTML = project.features
      .map((f: string, i: number) => `
        <li class="flex items-start gap-3 modal-feat" style="opacity:0; transform:translateX(-12px); transition: all 0.35s ease ${0.2 + i * 0.06}s">
          <div class="mt-1 w-5 h-5 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
            <svg class="w-3 h-3 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
          </div>
          <span class="text-text-muted">${f}</span>
        </li>
      `).join("");

    modalTech.innerHTML = project.technologies
      .map((t: string, i: number) => `<span class="px-3 py-1.5 text-xs font-mono text-text bg-surface-lighter/60 rounded-lg border border-border/40 modal-tech" style="opacity:0; transform:scale(0.8); transition: all 0.3s ease ${0.25 + i * 0.04}s">${t}</span>`)
      .join("");

    modal.classList.remove("pointer-events-none");
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";

    requestAnimationFrame(() => {
      backdrop.classList.remove("bg-black/0");
      backdrop.classList.add("bg-black/70");
      content.classList.remove("opacity-0", "scale-90", "translate-y-8");
      content.classList.add("opacity-100", "scale-100", "translate-y-0");

      setTimeout(() => {
        document.querySelectorAll(".modal-para, .modal-feat, .modal-tech").forEach((el) => {
          (el as HTMLElement).style.opacity = "1";
          (el as HTMLElement).style.transform = "none";
        });
      }, 200);
    });

    scrollArea.scrollTop = 0;
  }

  function closeModal() {
    backdrop.classList.remove("bg-black/70");
    backdrop.classList.add("bg-black/0");
    content.classList.remove("opacity-100", "scale-100", "translate-y-0");
    content.classList.add("opacity-0", "scale-90", "translate-y-8");

    setTimeout(() => {
      modal.classList.add("pointer-events-none");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }, 500);
  }

  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("pointer-events-none")) closeModal();
  });

  document.querySelectorAll("[data-open-project]").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      openModal((btn as HTMLElement).dataset.openProject!);
    });
  });
</script>
